geom_boxplot(outlier.shape = NA) +
geom_jitter(size = 2, pch = 21, alpha = 1, width = 0.25, height = 0,
aes(fill = Food), colour = "black") +
scale_fill_manual(values = c("#228833", "#EE6677", "#EE6677",
"#EE6677", "#228833", "#228833", "#228833",
"#228833", "#228833", "#228833")) +
labs(y = expression("kg "*CO[2]*" eq. / 100 g protein")) +
scale_y_continuous(expand = c(0.02,0.01)) +
theme_classic() +
theme(legend.position = "none",
axis.title.x = element_blank(),
axis.title.y = element_text(size = 14, face = "bold"),
axis.text.y = element_text(size = 12),
axis.text.x = element_text(size = 12, angle = 45, hjust = 1))
png("~/Desktop/Rumen/Figure1.png", width = 5, height = 5, units = "in", res = 300)
ggplot(f, aes(reorder(Food, CO2eq_100gProt, mean), CO2eq_100gProt)) +
geom_boxplot(outlier.shape = NA) +
geom_jitter(size = 2, pch = 21, alpha = 1, width = 0.25, height = 0,
aes(fill = Food), colour = "black") +
scale_fill_manual(values = c("#228833", "#EE6677", "#EE6677",
"#EE6677", "#228833", "#228833", "#228833",
"#228833", "#228833", "#228833")) +
labs(y = expression("kg "*CO[2]*" eq. / 100 g protein")) +
scale_y_continuous(expand = c(0.02,0.01)) +
theme_classic() +
theme(legend.position = "none",
axis.title.x = element_blank(),
axis.title.y = element_text(size = 14, face = "bold"),
axis.text.y = element_text(size = 12),
axis.text.x = element_text(size = 12, angle = 45, hjust = 1))
dev.off()
library(readxl)
library(tidyverse)
library(janitor)
# Plot with Paul Tol colorblind friendly palette
f <- read_xlsx("~/Desktop/Rumen/RuminantNumbers.xlsx", sheet = 5)
pdf("~/Desktop/Rumen/Figure1_noicon.pdf", width = 5, height = 5)
ggplot(f, aes(reorder(Food, CO2eq_100gProt, mean), CO2eq_100gProt)) +
geom_boxplot(outlier.shape = NA) +
geom_jitter(size = 2, pch = 21, alpha = 1, width = 0.25, height = 0,
aes(fill = Food), colour = "black") +
scale_fill_manual(values = c("#228833", "#EE6677", "#EE6677",
"#EE6677", "#228833", "#228833", "#228833",
"#228833", "#228833", "#228833")) +
labs(y = expression("kg "*CO[2]*" eq. / 100 g protein")) +
scale_y_continuous(expand = c(0.02,0.01)) +
theme_classic() +
theme(legend.position = "none",
axis.title.x = element_blank(),
axis.title.y = element_text(size = 14, face = "bold"),
axis.text.y = element_text(size = 12),
axis.text.x = element_text(size = 12, angle = 45, hjust = 1))
dev.off()
pdf("~/Desktop/Rumen/Figure1_noicon.pdf", width = 5, height = 4)
ggplot(f, aes(reorder(Food, CO2eq_100gProt, mean), CO2eq_100gProt)) +
geom_boxplot(outlier.shape = NA) +
geom_jitter(size = 2, pch = 21, alpha = 1, width = 0.25, height = 0,
aes(fill = Food), colour = "black") +
scale_fill_manual(values = c("#228833", "#EE6677", "#EE6677",
"#EE6677", "#228833", "#228833", "#228833",
"#228833", "#228833", "#228833")) +
labs(y = expression("kg "*CO[2]*" eq. / 100 g protein")) +
scale_y_continuous(expand = c(0.02,0.01)) +
theme_classic() +
theme(legend.position = "none",
axis.title.x = element_blank(),
axis.title.y = element_text(size = 14, face = "bold"),
axis.text.y = element_text(size = 12),
axis.text.x = element_text(size = 12, angle = 45, hjust = 1))
dev.off()
library(vegan)
dist <- readRDS("~/Desktop/dist.rds")
dim(dist)
dim(as.matrix(dist))
env <- readRDS("~/Desktop/env.rds")
dim(env)
mod0 <- dbrda(dist ~ 1, env)  # Model with intercept only
mod1 <- dbrda(dist ~ ., env)  # Model with all explanatory variables
set.seed(100)
mod <- ordistep(mod0, scope = formula(mod1))
mod$anova
library(microseq)
library(tidyverse)
db <- readFasta("~/Desktop/Fierer/Strains/trnL_taxDB_20250217.fasta")
View(db)
View(db)
db <- readFasta("~/Desktop/Fierer/Strains/trnL_taxDB_20250217.fasta") %>%
separate(Header, into = c("Junk", "Kingdom", "Phylum", "Class", "Order", "Family",
"Genus", "Species"), sep = ";") %>%
select(-Junk) %>%
mutate(Header = paste(Kingdom, Phylum, Class, Order, Family,
Genus, Species, sep = ";")) %>%
select(Header, Sequence)
View(db)
writeFasta(db, "~/Desktop/Fierer/Strains/trnL_taxDB_20250217_dada2.fasta")
library(microseq)
library(tidyverse)
bbdb <- readFasta("~/Downloads/all_prok_16S_species_consensus_dada2.fa.gz")
View(bbdb)
bbdb_check <- bbdb %>%
separate(Header,
into = c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species"),
sep = ";")
View(bbdb_check)
table(bbdb_check$Kingdom)
bbdb_check <- bbdb %>%
separate(Header,
into = c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species"),
sep = ";")
citation("vegan")
citation("ANCOMBC")
library(igraph)
citation("igraph")
library(ggplto2)
library(ggplot2)
citation("ggplot2")
d <- read.csv("~/Documents/GitHub/AussieStrains/data/metadata_331.csv")
table(d$vegetation_type)
# Select 15 arid grassland and 15 forest soils from BASE
library(tidyverse)
grassland <- d %<%
filter(vegetation_type == "Grassland")
grassland <- d %>%
filter(vegetation_type == "Grassland")
hist(grassland$AI)
grassland <- d %>%
filter(vegetation_type == "Grassland") %>%
arrange(AI)
View(grassland)
head(grassland, n = 15)
head(grassland$sampleID, n = 15)
forest <- d %>%
filter(vegetation_type == "Forest") %>%
arrange(AI)
head(forest$sampleID, n = 15)
hist(forest$AI)
forest <- d %>%
filter(vegetation_type == "Forest") %>%
arrange(desc(AI))
hist(forest$AI)
head(forest$AI, n = 15)
head(grassland$AI, n = 15)
head(grassland$sampleID, n = 15)
head(forest$sampleID, n = 15)
accession2url <- function(x) {
prefix <- "ftp://ftp.sra.ebi.ac.uk/vol1/fastq"
dir1 <- paste0("/",substr(x,1,6))
dir2 <- ifelse(nchar(x) == 9, "",
ifelse(nchar(x) == 10, paste0("/00",substr(x,10,10)),
ifelse(nchar(x) == 11, paste0("/0",substr(x,10,11)),
paste0("/",substr(x,10,12)))))
paste0(prefix,dir1,dir2,"/",x)
}
accession2url(ERR3452699)
accession2url("ERR3452699")
accession2urlR1 <- function(x) {
prefix <- "ftp://ftp.sra.ebi.ac.uk/vol1/fastq"
dir1 <- paste0("/",substr(x,1,6))
dir2 <- ifelse(nchar(x) == 9, "",
ifelse(nchar(x) == 10, paste0("/00",substr(x,10,10)),
ifelse(nchar(x) == 11, paste0("/0",substr(x,10,11)),
paste0("/",substr(x,10,12)))))
paste0(prefix,dir1,dir2,"/",x,"/",x,"_1.fastq.gz")
}
accession2url("ERR3452699")
accession2urlR1("ERR3452699")
accession2urlR2 <- function(x) {
prefix <- "ftp://ftp.sra.ebi.ac.uk/vol1/fastq"
dir1 <- paste0("/",substr(x,1,6))
dir2 <- ifelse(nchar(x) == 9, "",
ifelse(nchar(x) == 10, paste0("/00",substr(x,10,10)),
ifelse(nchar(x) == 11, paste0("/0",substr(x,10,11)),
paste0("/",substr(x,10,12)))))
paste0(prefix,dir1,dir2,"/",x,"/",x,"_2.fastq.gz")
}
accession2urlR2("ERR3452699")
accession2urlR1("ERR3452574")
accession2urlR2("ERR3452574")
accession2urlR1("ERR3452529")
accession2urlR2("ERR3452529")
accession2urlR1("ERR3452318")
accession2urlR2("ERR3452318")
accession2urlR1("ERR3452699")
accession2urlR2("ERR3452699")
accession2urlR1("ERR3452574")
accession2urlR2("ERR3452574")
accession2urlR1("ERR3452529")
accession2urlR2("ERR3452529")
accession2urlR1("ERR3452318")
accession2urlR2("ERR3452318")
accession2urlR1("ERR3451635")
accession2urlR2("ERR3451635")
accession2urlR1("ERR2641799")
accession2urlR2("ERR2641799")
accession2urlR1("ERR2641792")
accession2urlR2("ERR2641792")
accession2urlR1("ERR2641793")
accession2urlR2("ERR2641793")
accession2urlR1("ERR2641795")
accession2urlR2("ERR2641795")
accession2urlR1("ERR2641798")
accession2urlR2("ERR2641798")
library(plyr) # For data manipulation
library(tidyverse) # For data manipulation
library(mctoolsr) # For microbial analyses
library(vegan) # For multivariate stats
library(RColorBrewer) # For colors
library(microseq) # For fastas
library(car) # For stats
library(MASS) # For stats
library(FSA) # For SE
library(lme4) # For LMER
library(emmeans) # For TukeyHSD
library(multcomp) # For cld
library(lmerTest) # For Sattherwaite df
library(afex) # For alternative mixed model
library(ggh4x) # For plots
library(ggrepel) # For plot text
library(cowplot) # For multipanel
library(phyloseq) # For networks
library(SpiecEasi) # For networks
library(igraph) # For networks
library(rnetcarto) # For networks
library(writexl) # Export
library(naniar) # For NA management
library(pheatmap) # For heatmaps
library(iCAMP) # NTI
library(ape) # Phylogenetics
library(phyloseq) # microbial analyses, can handle trees
library(picante) # Trees
library(conditionz)
library(taxize) # version 0.9.100.1 from archive
library(readxl)
# Repo Directory
setwd("~/Documents/GitHub/SunflowerG/")
# Functions
`%notin%` <- Negate(`%in%`)
find_hull <- function(df) df[chull(df$Axis01, df$Axis02),]
source("code/effectSize.R")
source("code/run_taxa_null_model.R")
source("code/run_div_null_model.R")
source("code/run_sclero_regressions.R")
MyDiamond <- function(coords, v=NULL, params) {
vertex.color <- params("vertex", "color")
if (length(vertex.color) != 1 && !is.null(v)) {
vertex.color <- vertex.color[v]
}
vertex.frame.color <- params("vertex", "frame.color")
if (length(vertex.frame.color) != 1 && !is.null(v)) {
vertex.frame.color <- vertex.frame.color[v]
}
vertex.size <- 1/200 * params("vertex", "size")
if (length(vertex.size) != 1 && !is.null(v)) {
vertex.size <- vertex.size[v]
}
symbols(x=coords[,1], y=coords[,2], bg=vertex.color, fg=vertex.frame.color,
stars=cbind(vertex.size, vertex.size, vertex.size, vertex.size),
add=TRUE, inches=FALSE)
}
add_shape("diamond", clip=shapes("circle")$clip,
plot=MyDiamond, parameters=list(vertex.frame.color="white",
vertex.frame.width=1))
mytriangle <- function(coords, v=NULL, params) {
vertex.color <- params("vertex", "color")
if (length(vertex.color) != 1 && !is.null(v)) {
vertex.color <- vertex.color[v]
}
vertex.size <- 1/200 * params("vertex", "size")
if (length(vertex.size) != 1 && !is.null(v)) {
vertex.size <- vertex.size[v]
}
symbols(x=coords[,1], y=coords[,2], bg=vertex.color,
stars=cbind(vertex.size, vertex.size, vertex.size),
add=TRUE, inches=FALSE)
}
add_shape("triangle", clip=shapes("circle")$clip,
plot=mytriangle)
#### _Start here ####
input_n3_16S <- readRDS("data/input_filt_16S_noSing.rds")
input_n3_ITS <- readRDS("data/input_filt_ITS_noSing.rds")
input_n3_16S$map_loaded$rich <- specnumber(input_n3_16S$data_loaded,
MARGIN = 2)
input_n3_16S$map_loaded$shannon <- vegan::diversity(input_n3_16S$data_loaded,
index = "shannon",
MARGIN = 2)
input_n3_ITS$map_loaded$rich <- specnumber(input_n3_ITS$data_loaded,
MARGIN = 2)
input_n3_ITS$map_loaded$shannon <- vegan::diversity(input_n3_ITS$data_loaded,
index = "shannon",
MARGIN = 2)
#### _Leo ####
# Send networks to Leo
# Prok, Fung, and Prok/Fung
# Use cutoff of 37% prevalence, which is what was used in the SPIEC-EASI paper
# 368*0.37 = 136
top_16S <- input_n3_16S$data_loaded %>%
mutate(Ubiquity = rowSums(. > 0)) %>%
filter(Ubiquity >= 137)
input_abund_16S <- filter_taxa_from_input(input_n3_16S,
taxa_IDs_to_keep = rownames(top_16S),
at_spec_level = 8)
nrow(input_abund_16S$data_loaded) # 1462
otu_16S <- otu_table(input_abund_16S$data_loaded, taxa_are_rows = T)
tax_16S <- tax_table(as.matrix(input_abund_16S$taxonomy_loaded))
map_16S <- sample_data(input_abund_16S$map_loaded)
input_phy_16S <- phyloseq(otu_16S, tax_16S, map_16S)
# Too big! Do on microbe with multiple cores
saveRDS(input_phy_16S, "input_phy_16S.rds")
# Too big! Do on microbe with multiple cores
saveRDS(input_phy_16S, "data/input_phy_16S.rds")
View(input_n3_ITS$taxonomy_loaded)
top_ITS <- input_n3_ITS$data_loaded %>%
mutate(Ubiquity = rowSums(. > 0)) %>%
filter(Ubiquity >= 137)
input_abund_ITS <- filter_taxa_from_input(input_n3_ITS,
taxa_IDs_to_keep = rownames(top_ITS),
at_spec_level = 8)
nrow(input_abund_ITS$data_loaded) # 100
otu_ITS <- otu_table(input_abund_ITS$data_loaded, taxa_are_rows = T)
tax_ITS <- tax_table(as.matrix(input_abund_ITS$taxonomy_loaded))
map_ITS <- sample_data(input_abund_ITS$map_loaded)
input_phy_ITS <- phyloseq(otu_ITS, tax_ITS, map_ITS)
se_mb_ITS <- spiec.easi(input_phy_ITS,
method = 'mb',
lambda.min.ratio = 1e-2,
nlambda = 20,
pulsar.params = list(rep.num = 50))
saveRDS(se_mb_ITS, "data/se_mb_ITS.rds")
net_ITS <- adj2igraph(getRefit(se_mb_ITS),
vertex.attr=list(name = taxa_names(input_phy_ITS)))
set.seed(1)
plot_network(net_ITS,
input_phy_ITS,
type = 'taxa',
color = "taxonomy3",
point_size = 3,
label = NULL) +
labs(color = "Class") +
ggtitle("ITS Network (top 100)") +
theme(plot.title = element_text(size = 14, face = "bold", hjust = 0.5))
plot_network(net_ITS,
input_phy_ITS,
type = 'taxa',
color = "taxonomy3",
point_size = 3,
label = NULL) +
labs(color = "Class") +
ggtitle("ITS Network (n = 196)") +
theme(plot.title = element_text(size = 14, face = "bold", hjust = 0.5))
pdf("InitialFigs/Network_ITS_196.pdf", width = 7, height = 5)
set.seed(1)
plot_network(net_ITS,
input_phy_ITS,
type = 'taxa',
color = "taxonomy3",
point_size = 3,
label = NULL) +
labs(color = "Class") +
ggtitle("ITS Network (n = 196)") +
theme(plot.title = element_text(size = 14, face = "bold", hjust = 0.5))
dev.off()
E(net_ITS)
V(net_ITS)
saveRDS(net_ITS, "data/net_ITS.rds")
se_mb_ITS$lambda
bm_ITS <- symBeta(getOptBeta(se_mb_ITS), mode = "maxabs")
diag(bm_ITS) <- 0
weights <- Matrix::summary(t(bm_ITS))[,3]
weights
E(net_ITS)$weight <- weights
E(net_ITS)[weight > 0]$color <-"blue" # positive blue
E(net_ITS)[weight < 0]$color <-"red"  # negative red
edge_attr(net_ITS)
saveRDS(net_ITS, "data/net_ITS.rds")
E(net_ITS)$weight
# Need to create unique prok and euk ESV (ASV) IDs
# Unique ASV IDs are needed for rownames of $data_loaded and $taxonomy_loaded
# Also filter 16S data to ITS data
input_abund_16S <- filter_data(input_abund_16S,
filter_cat = "sampleID",
keep_vals = input_n3_ITS$map_loaded$sampleID)
input_abund_16S_toMerge <- input_abund_16S
num_16S <- seq(1:nrow(input_abund_16S_toMerge$data_loaded))
ASVlabel_16S <- rep("ASV_Prok_", nrow(input_abund_16S_toMerge$data_loaded))
IDs_16S <- paste(ASVlabel_16S, num_16S, sep = "")
rownames(input_abund_16S_toMerge$data_loaded) <- IDs_16S
rownames(input_abund_16S_toMerge$taxonomy_loaded) <- IDs_16S
input_abund_16S_toMerge$taxonomy_loaded$taxonomy9 <- IDs_16S
input_abund_ITS_toMerge <- input_abund_ITS
num_ITS <- seq(1:nrow(input_abund_ITS_toMerge$data_loaded))
ASVlabel_ITS <- rep("ASV_Euk_", nrow(input_abund_ITS_toMerge$data_loaded))
IDs_ITS <- paste(ASVlabel_ITS, num_ITS, sep = "")
rownames(input_abund_ITS_toMerge$data_loaded) <- IDs_ITS
rownames(input_abund_ITS_toMerge$taxonomy_loaded) <- IDs_ITS
input_abund_ITS_toMerge$taxonomy_loaded$taxonomy9 <- IDs_ITS
input_filt_abund_combined <- input_abund_16S_toMerge
input_filt_abund_combined$data_loaded <- rbind(input_filt_abund_combined$data_loaded,
input_abund_ITS_toMerge$data_loaded)
input_filt_abund_combined$taxonomy_loaded <- rbind(input_filt_abund_combined$taxonomy_loaded,
input_abund_ITS_toMerge$taxonomy_loaded)
nrow(input_filt_abund_combined$data_loaded) # 200 total taxa
# Convert mctoolsr to phyloseq
names(input_filt_abund_combined$taxonomy_loaded) <- c("Domain", "Phylum", "Class", "Order",
"Family", "Genus", "Species", "ASV_ID",
"ASV_ID2")
otu <- otu_table(input_filt_abund_combined$data_loaded, taxa_are_rows = T)
tax <- tax_table(as.matrix(input_filt_abund_combined$taxonomy_loaded))
map <- sample_data(input_filt_abund_combined$map_loaded)
input.phy <- phyloseq(otu, tax, map)
saveRDS(input.phy, "data/input.phy.rds")
# Too big! Do on microbe with multiple cores
#saveRDS(input_phy_16S, "data/input_phy_16S.rds")
# se_mb_16S <- spiec.easi(input_phy_16S,
#                         method = 'mb',
#                         lambda.min.ratio = 1e-2,
#                         nlambda = 20,
#                         pulsar.params = list(rep.num = 50))
se_mb_16S <- readRDS("~/Desktop/se_mb_16S.rds")
net_16S <- adj2igraph(getRefit(se_mb_16S),
vertex.attr=list(name = taxa_names(input_phy_16S)))
saveRDS(net_16S, "data/net_16S.rds")
se_mb_16S$lambda
bm_16S <- symBeta(getOptBeta(se_mb_16S), mode = "maxabs")
diag(bm_16S) <- 0
weights <- Matrix::summary(t(bm_16S))[,3]
E(net_16S)$weight <- weights
E(net_16S)[weight > 0]$color <-"blue" # positive blue
E(net_16S)[weight < 0]$color <-"red"  # negative red
edge_attr(net_16S)
E(net_16S)
V(net_16S)
saveRDS(net_16S, "data/net_16S.rds")
set.seed(1)
plot_network(net_16S,
input_phy_16S,
type = 'taxa',
color = "taxonomy2",
shape = "taxonomy1",
point_size = 3,
label = NULL) +
labs(shape = "Domain",
color = "Phylum") +
guides(shape = guide_legend(order = 1),
color = guide_legend(override.aes = list(shape = c(17,17,17,17,
16,17,17,17,
17,17,17,17)))) +
ggtitle("16S Network (top 100)") +
theme(plot.title = element_text(size = 14, face = "bold", hjust = 0.5))
set.seed(1)
plot_network(net_16S,
input_phy_16S,
type = 'taxa',
color = "taxonomy1",
point_size = 3,
label = NULL) +
labs(color = "Class") +
ggtitle("16S Network (n = 1462)") +
theme(plot.title = element_text(size = 14, face = "bold", hjust = 0.5))
net_16S <- adj2igraph(getRefit(se_mb_16S),
vertex.attr=list(name = taxa_names(input_phy_16S)))
set.seed(1)
plot_network(net_16S,
input_phy_16S,
type = 'taxa',
color = "taxonomy1",
point_size = 3,
label = NULL) +
labs(color = "Class") +
ggtitle("16S Network (n = 1462)") +
theme(plot.title = element_text(size = 14, face = "bold", hjust = 0.5))
set.seed(1)
plot_network(net_16S,
input_phy_16S,
type = 'taxa',
color = "taxonomy2",
point_size = 3,
label = NULL) +
labs(color = "Class") +
ggtitle("16S Network (n = 1462)") +
theme(plot.title = element_text(size = 14, face = "bold", hjust = 0.5))
bm_16S <- symBeta(getOptBeta(se_mb_16S), mode = "maxabs")
diag(bm_16S) <- 0
weights <- Matrix::summary(t(bm_16S))[,3]
E(net_16S)$weight <- weights
E(net_16S)[weight > 0]$color <-"blue" # positive blue
E(net_16S)[weight < 0]$color <-"red"  # negative red
edge_attr(net_16S)
E(net_16S)
V(net_16S)
saveRDS(net_16S, "data/net_16S.rds")
# Too big! Do on microbe with multiple cores
# saveRDS(input.phy, "data/input.phy.rds")
# se.mb2 <- spiec.easi(input.phy,
#                      method='mb',
#                      lambda.min.ratio=1e-2,
#                      nlambda=20,
#                      pulsar.params=list(rep.num=50))
se_mb <- readRDS("~/Desktop/se_mb.rds")
net <- adj2igraph(getRefit(se_mb),
vertex.attr=list(name = taxa_names(input.phy)))
se_mb$lambda
bm <- symBeta(getOptBeta(se_mb), mode = "maxabs")
diag(bm) <- 0
weights <- Matrix::summary(t(bm))[,3]
E(net)$weight <- weights
E(net)[weight > 0]$color <-"blue" # positive blue
E(net)[weight < 0]$color <-"red"  # negative red
edge_attr(net)
E(net)
V(net)
saveRDS(net, "data/net.rds")
E(net_16S)
